{% extends "base.html" %}
{% block title %}Dashboard - Lumen{% endblock %}

{% block head %}
<!-- No local styles needed, using global style.css -->
{% endblock %}

{% block content %}
<div class="dashboard-header" style="margin-bottom: 24px;">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h1 class="page-title" style="margin: 0;">Dashboard</h1>
        <button class="btn-primary btn-pill" onclick="refreshAnalytics()">
            üîÑ Refresh Data
        </button>
    </div>
</div>

<!-- Flash Messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
{% if messages %}
<div class="flash-wrap">
    {% for category, message in messages %}
    <div class="flash {{ category }}">{{ message }}</div>
    {% endfor %}
</div>
{% endif %}
{% endwith %}

<!-- Loading State -->
<div id="loading" style="text-align: center; padding: 60px; color: #718096;">
    <div style="font-size: 48px; margin-bottom: 16px;">‚è≥</div>
    <div>Loading analytics...</div>
</div>

<!-- Error State -->
<div id="error" class="flash error" style="display: none;"></div>

<!-- Dashboard Content -->
<div id="content" class="dashboard-grid" style="display: none;">

    <!-- ROW 1: METRICS -->
    <div class="metrics-row">
        <!-- Total Debit -->
        <div class="card card-purple">
            <span class="card-chip">Total Debit</span>
            <div class="metric-value" id="debitTotal">‚Çπ0</div>
        </div>

        <!-- Total Credit -->
        <div class="card card-purple">
            <span class="card-chip">Total Credit</span>
            <div class="metric-value" id="creditTotal">‚Çπ0</div>
        </div>

        <!-- Net Flow -->
        <div class="card card-purple">
            <span class="card-chip">Net Flow</span>
            <div class="metric-value" id="netFlow">‚Çπ0</div>
        </div>

        <!-- Transactions -->
        <div class="card card-purple">
            <span class="card-chip">Transactions</span>
            <div class="metric-value" id="txnCount">0</div>
        </div>
    </div>

    <!-- ROW 2: CHARTS -->
    <div class="charts-row">
        <!-- Left: Expenditure Chart (Mustard) -->
        <div class="card card-mustard">
            <div class="chart-header" style="display: flex; justify-content: space-between; margin-bottom: 16px;">
                <h3>Expenditure</h3>
                <div class="toggle-pill-container">
                    <button class="toggle-btn active">Monthly</button>
                    <button class="toggle-btn">Weekly</button>
                </div>
            </div>
            <div class="chart-container" style="height: 300px;">
                <canvas id="barChart"></canvas>
            </div>
        </div>

        <!-- Right: Expenditure Split (Sage) -->
        <div class="card card-sage">
            <div class="chart-header" style="margin-bottom: 16px; text-align: center;">
                <h3>Expenditure Split</h3>
            </div>
            <!-- Month Selector -->
            <div style="display: flex; justify-content: center; align-items: center; gap: 8px; margin-bottom: 20px;">
                <button class="btn-secondary btn-pill"
                    style="padding: 4px 12px; font-size: 12px; border-color: rgba(0,0,0,0.2); color: inherit;">‚Üê</button>
                <div style="font-weight: 600; font-size: 14px;">February 2026</div>
                <button class="btn-secondary btn-pill"
                    style="padding: 4px 12px; font-size: 12px; border-color: rgba(0,0,0,0.2); color: inherit;">‚Üí</button>
            </div>

            <div class="donut-container">
                <canvas id="donutChart"></canvas>
            </div>
            <div class="donut-legend" id="donutLegend" style="margin-top: 16px;">
                <!-- Filled by JS -->
            </div>
        </div>
    </div>

    <!-- ROW 3: ALERTS & INSIGHTS -->
    <div class="bottom-row">
        <!-- Detected Patterns (Orange) -->
        <div class="card card-orange">
            <div class="chart-header">
                <h3>Detected Pattern</h3>
            </div>
            <ul id="patternsList" style="margin-left: 20px; color: rgba(0,0,0,0.7); font-weight: 500;">
                <li>Analyzing patterns...</li>
            </ul>
        </div>

        <!-- AI Insights (Outline/Card) -->
        <div class="card card-outline">
            <div class="chart-header">
                <h3
                    style="color: var(--text-main); border: 1px solid var(--border-color); display: inline-block; padding: 4px 12px; border-radius: 20px;">
                    AI Insight</h3>
            </div>
            <div id="aiSummary" style="color: var(--text-muted); line-height: 1.6; margin-top: 12px;">
                <!-- AI content -->
                <ul id="recommendationsList" style="list-style: none; padding: 0;">
                    <!-- Recommendations injected here -->
                </ul>
            </div>
        </div>

        <!-- Upload Receipt (Hidden/Optional or integrated?) -->
        <!-- Keeping it simple as per redesign request focusing on visual layout for dashboard -->
        <div class="card card-outline" style="text-align: center; border-style: dashed;">
            <h3 style="color: var(--text-muted);">Quick File Upload</h3>
            <div style="margin-top: 12px; display: flex; gap: 8px; justify-content: center;">
                <input type="file" id="receiptUpload" accept=".jpg,.jpeg,.png,.pdf" style="width: auto;">
                <button class="btn-primary btn-pill" onclick="uploadReceiptFile()">Upload</button>
            </div>
        </div>

    </div>

</div>

<script>
    // Profile Dropdown Toggle
    function toggleProfileDropdown() {
        const dropdown = document.getElementById('profileDropdown');
        if (dropdown.style.display === 'none' || dropdown.style.display === '') {
            dropdown.style.display = 'block';
        } else {
            dropdown.style.display = 'none';
        }
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', function (event) {
        const dropdown = document.getElementById('profileDropdown');
        const profile = document.querySelector('.sidebar-profile');
        if (dropdown && profile && !profile.contains(event.target)) {
            dropdown.style.display = 'none';
        }
    });

    let currentData = null;

    // Chart.js Configuration for new design
    // Colors tuned for dark pastel theme
    Chart.defaults.color = 'rgba(255, 255, 255, 0.6)';
    Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.1)';
    Chart.defaults.plugins.legend.display = false;

    let barChartInstance = null;
    let donutChartInstance = null;


    async function loadAnalytics() {
        const loading = document.getElementById('loading');
        const error = document.getElementById('error');
        const content = document.getElementById('content');

        loading.style.display = 'block';
        error.style.display = 'none';
        content.style.display = 'none';

        try {
            const response = await fetch('/api/anomalies-data');
            const data = await response.json();

            if (!data.success) {
                throw new Error(data.error || 'Failed to load analytics');
            }

            currentData = data;
            displayAnalytics(data);

            loading.style.display = 'none';
            content.style.display = 'grid'; // Changed to grid

        } catch (err) {
            console.error('Analytics error:', err);
            loading.style.display = 'none';
            error.style.display = 'block';
            error.textContent = `Error loading analytics: ${err.message}`;
        }
    }

    function displayAnalytics(data) {
        // Update stat cards
        document.getElementById('debitTotal').textContent = `‚Çπ${(data.debit_total || 0).toLocaleString()}`;
        document.getElementById('creditTotal').textContent = `‚Çπ${(data.credit_total || 0).toLocaleString()}`;
        document.getElementById('netFlow').textContent = `‚Çπ${(data.net_flow || 0).toLocaleString()}`;
        document.getElementById('txnCount').textContent = data.transaction_count || (data.transactions ? data.transactions.length : '0'); // Fallback logic

        // Create Bar Chart
        createBarChart(data);

        // Create Donut Chart
        createDonutChart(data);

        // Display patterns
        displayPatterns(data.patterns || []);

        // Display recommendations
        displayRecommendations(data.recommendations || [], data.ai_summary);
    }

    function createBarChart(data) {
        const ctx = document.getElementById('barChart');
        if (!ctx) return;

        if (barChartInstance) {
            barChartInstance.destroy();
        }

        const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        const currentMonth = new Date().getMonth();
        const last6Months = [];
        for (let i = 5; i >= 0; i--) {
            last6Months.push(months[(currentMonth - i + 12) % 12]);
        }

        // Dark theme colors for charts inside Mustard/Sage cards
        // Actually, inside a Mustard card (Light BG), we want DARK bars.
        // The text color inside mustard card is dark (from CSS).
        // So charts should use dark colors.

        const barColorDebit = '#1a365d'; // Dark Navy
        const barColorCredit = '#4a5568'; // Dark Grey for contrast

        barChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: last6Months,
                datasets: [
                    {
                        label: 'Debit',
                        data: [4500, 3200, 5100, 2800, 4200, data.debit_total || 3500],
                        backgroundColor: '#000000', // Black for stark contrast on mustard
                        borderRadius: 4,
                        barThickness: 20
                    },
                    {
                        label: 'Credit',
                        data: [2000, 4500, 3000, 5200, 2100, data.credit_total || 4000],
                        backgroundColor: 'rgba(0,0,0,0.4)',
                        borderRadius: 4,
                        barThickness: 20
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: '#1a365d',
                        titleColor: '#fff',
                        bodyColor: '#fff',
                        padding: 12,
                        cornerRadius: 8
                    }
                },
                scales: {
                    x: {
                        grid: { display: false },
                        ticks: { color: 'rgba(0,0,0,0.6)', font: { size: 11 } } // Dark ticks
                    },
                    y: {
                        grid: { color: 'rgba(0,0,0,0.1)' },
                        ticks: { color: 'rgba(0,0,0,0.6)', font: { size: 11 } },
                        beginAtZero: true
                    }
                }
            }
        });
    }

    function createDonutChart(data) {
        const ctx = document.getElementById('donutChart');
        if (!ctx) return;

        if (donutChartInstance) {
            donutChartInstance.destroy();
        }

        const labels = data.category_labels || ['Shopping', 'Food', 'Bills', 'Other'];
        const values = data.category_values || [35, 25, 20, 20];
        // Dark/Neutral colors for Sage background
        const colors = ['#1a202c', '#4a5568', '#718096', '#a0aec0'];

        donutChartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: values,
                    backgroundColor: colors,
                    borderWidth: 0,
                    cutout: '60%'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: '#1a365d',
                        titleColor: '#fff'
                    }
                }
            }
        });

        // Update legend
        const legendContainer = document.getElementById('donutLegend');
        legendContainer.innerHTML = labels.map((label, i) => `
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 4px; font-size: 13px; color: rgba(0,0,0,0.7);">
                <div style="display: flex; align-items: center; gap: 8px;">
                     <span style="width: 8px; height: 8px; border-radius: 50%; background: ${colors[i]}"></span>
                     <span>${label}</span>
                </div>
                <strong>${values[i]}%</strong>
            </div>
        `).join('');
    }

    function displayPatterns(patterns) {
        const list = document.getElementById('patternsList');
        list.innerHTML = '';

        if (patterns.length > 0) {
            patterns.forEach(pattern => {
                const li = document.createElement('li');
                li.style.cssText = 'padding: 8px 0; border-bottom: 1px solid rgba(0,0,0,0.1); margin-bottom: 4px;';
                li.textContent = '‚Ä¢ ' + pattern;
                list.appendChild(li);
            });
        } else {
            list.innerHTML = '<li>No patterns detected yet</li>';
        }
    }

    function displayRecommendations(recommendations, summary) {
        const list = document.getElementById('recommendationsList');
        list.innerHTML = '';

        // Add summary paragraph first if exists
        if (summary) {
            const p = document.createElement('p');
            p.textContent = summary;
            p.style.marginBottom = '12px';
            list.appendChild(p);
        }

        if (recommendations.length > 0) {
            recommendations.forEach(rec => {
                const li = document.createElement('li');
                li.style.cssText = 'padding: 8px 0; font-size: 14px; display: flex; gap: 8px;';
                li.innerHTML = '<span style="color: var(--card-mustard);">‚Ä¢</span> ' + rec;
                list.appendChild(li);
            });
        }
    }

    function refreshAnalytics() {
        loadAnalytics();
    }

    function showToast(message, isError = false) {
        const toast = document.createElement('div');
        toast.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            background: ${isError ? '#ef4444' : '#10b981'};
            color: white;
            border-radius: 8px;
            font-weight: 600;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            z-index: 9999;
            animation: slideIn 0.3s ease;
        `;
        toast.textContent = message;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 4000);
    }

    // Simple Upload
    async function uploadReceiptFile() {
        const input = document.getElementById('receiptUpload');
        const file = input.files[0];
        if (!file) { showToast('Select file', true); return; }

        const formData = new FormData();
        formData.append('file', file);
        showToast('Uploading...');

        try {
            const r = await fetch('/upload-receipt', { method: 'POST', body: formData });
            const d = await r.json();
            if (d.success) showToast('Done!');
            else showToast('Failed', true);
        } catch (e) { showToast('Error', true); }
    }

    // Load on init
    document.addEventListener('DOMContentLoaded', loadAnalytics);
</script>

<style>
    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }

        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
</style>
{% endblock %}