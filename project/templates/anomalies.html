{% extends "base.html" %}
{% block title %}Dashboard - Lumen{% endblock %}

{% block head %}
<!-- No local styles needed, using global style.css -->
{% endblock %}

{% block content %}
<div class="dashboard-header" style="margin-bottom: 24px;">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h1 class="page-title" style="margin: 0;">Dashboard</h1>
        <button class="btn-primary btn-pill" onclick="refreshAnalytics()">
            üîÑ Refresh Data
        </button>
    </div>
</div>

<!-- Flash Messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
{% if messages %}
<div class="flash-wrap">
    {% for category, message in messages %}
    <div class="flash {{ category }}">{{ message }}</div>
    {% endfor %}
</div>
{% endif %}
{% endwith %}

<!-- Loading State -->
<div id="loading" style="text-align: center; padding: 60px; color: #718096;">
    <div style="font-size: 48px; margin-bottom: 16px;">‚è≥</div>
    <div>Loading analytics...</div>
</div>

<!-- Error State -->
<div id="error" class="flash error" style="display: none;"></div>

<!-- Dashboard Content -->
<div id="content" class="dashboard-grid" style="display: none;">

    <!-- ROW 1: METRICS -->
    <div class="metrics-row">
        <!-- Total Debit -->
        <div class="card card-purple">
            <span class="card-chip">Total Debit</span>
            <div class="metric-value" id="debitTotal">‚Çπ0</div>
        </div>

        <!-- Total Credit -->
        <div class="card card-purple">
            <span class="card-chip">Total Credit</span>
            <div class="metric-value" id="creditTotal">‚Çπ0</div>
        </div>

        <!-- Net Flow -->
        <div class="card card-purple">
            <span class="card-chip">Net Flow</span>
            <div class="metric-value" id="netFlow">‚Çπ0</div>
        </div>

        <!-- Transactions -->
        <div class="card card-purple">
            <span class="card-chip">Transactions</span>
            <div class="metric-value" id="txnCount">0</div>
        </div>
    </div>

    <!-- ROW 2: CHARTS -->
    <div class="charts-row">
        <!-- Left: Expenditure Chart (Mustard) -->
        <div class="card card-mustard">
            <div class="chart-header" style="display: flex; justify-content: space-between; margin-bottom: 16px;">
                <h3>Expenditure</h3>
                <div class="toggle-pill-container">
                    <button class="toggle-btn active">Monthly</button>
                    <button class="toggle-btn">Weekly</button>
                </div>
            </div>
            <div class="chart-container" style="height: 300px;">
                <canvas id="barChart"></canvas>
            </div>
        </div>

        <!-- Right: Expenditure Split (Sage) -->
        <div class="card card-sage">
            <div class="chart-header" style="margin-bottom: 16px; text-align: center;">
                <h3>Expenditure Split</h3>
            </div>
            <!-- Month Selector -->
            <div style="display: flex; justify-content: center; align-items: center; gap: 8px; margin-bottom: 20px;">
                <button class="btn-secondary btn-pill"
                    style="padding: 4px 12px; font-size: 12px; border-color: rgba(0,0,0,0.2); color: inherit;">‚Üê</button>
                <div style="font-weight: 600; font-size: 14px;">February 2026</div>
                <button class="btn-secondary btn-pill"
                    style="padding: 4px 12px; font-size: 12px; border-color: rgba(0,0,0,0.2); color: inherit;">‚Üí</button>
            </div>

            <div class="donut-container">
                <canvas id="donutChart"></canvas>
            </div>
            <div class="donut-legend" id="donutLegend" style="margin-top: 16px;">
                <!-- Filled by JS -->
            </div>
        </div>
    </div>

    <!-- ROW 3: ALERTS & INSIGHTS -->
    <div class="bottom-row">
        <!-- Detected Patterns (Orange) -->
        <div class="card card-orange">
            <div class="chart-header">
                <h3>Detected Pattern</h3>
            </div>
            <ul id="patternsList" style="margin-left: 20px; color: rgba(0,0,0,0.7); font-weight: 500;">
                <li>Analyzing patterns...</li>
            </ul>
        </div>

        <!-- AI Insights (Outline/Card) -->
        <div class="card card-outline">
            <div class="chart-header">
                <h3
                    style="color: var(--text-main); border: 1px solid var(--border-color); display: inline-block; padding: 4px 12px; border-radius: 20px;">
                    AI Insight</h3>
            </div>
            <div id="aiSummary" style="color: var(--text-muted); line-height: 1.6; margin-top: 12px;">
                <!-- AI content -->
                <ul id="recommendationsList" style="list-style: none; padding: 0;">
                    <!-- Recommendations injected here -->
                </ul>
            </div>
        </div>

        <!-- Upload Receipt (Hidden/Optional or integrated?) -->
        <!-- Keeping it simple as per redesign request focusing on visual layout for dashboard -->
        <div class="card card-outline" style="text-align: center; border-style: dashed;">
            <h3 style="color: var(--text-muted);">Quick File Upload</h3>
            <div style="margin-top: 12px; display: flex; gap: 8px; justify-content: center;">
                <input type="file" id="receiptUpload" accept=".jpg,.jpeg,.png,.pdf" style="width: auto;">
                <button class="btn-primary btn-pill" onclick="uploadReceiptFile()">Upload</button>
            </div>
        </div>

    </div>

</div>

<script>
    // Profile Dropdown Toggle
    function toggleProfileDropdown() {
        const dropdown = document.getElementById('profileDropdown');
        if (dropdown.style.display === 'none' || dropdown.style.display === '') {
            dropdown.style.display = 'block';
        } else {
            dropdown.style.display = 'none';
        }
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', function (event) {
        const dropdown = document.getElementById('profileDropdown');
        const profile = document.querySelector('.sidebar-profile');
        if (dropdown && profile && !profile.contains(event.target)) {
            dropdown.style.display = 'none';
        }
    });

    let currentData = null;
    let barChartInstance = null;
    let donutChartInstance = null;

    // State for interactive features
    let currentView = 'monthly'; // 'monthly' or 'weekly'
    let donutMonth = new Date().getMonth() + 1; // 1-12
    let donutYear = new Date().getFullYear();
    const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];


    // Chart.js Configuration for new design
    // Colors tuned for dark pastel theme
    Chart.defaults.color = 'rgba(255, 255, 255, 0.6)';
    Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.1)';
    Chart.defaults.plugins.legend.display = false;


    async function loadAnalytics() {
        const loading = document.getElementById('loading');
        const error = document.getElementById('error');
        const content = document.getElementById('content');

        loading.style.display = 'block';
        error.style.display = 'none';
        content.style.display = 'none';

        try {
            const response = await fetch('/api/anomalies-data');
            const data = await response.json();

            if (!data.success) {
                throw new Error(data.error || 'Failed to load analytics');
            }

            currentData = data;
            displayAnalytics(data);

            loading.style.display = 'none';
            content.style.display = 'grid'; // Changed to grid

        } catch (err) {
            console.error('Analytics error:', err);
            loading.style.display = 'none';
            error.style.display = 'block';
            error.textContent = `Error loading analytics: ${err.message}`;
        }
    }

    function displayAnalytics(data) {
        // Update stat cards
        document.getElementById('debitTotal').textContent = `‚Çπ${(data.debit_total || 0).toLocaleString()}`;
        document.getElementById('creditTotal').textContent = `‚Çπ${(data.credit_total || 0).toLocaleString()}`;
        document.getElementById('netFlow').textContent = `‚Çπ${(data.net_flow || 0).toLocaleString()}`;
        document.getElementById('txnCount').textContent = data.transaction_count || (data.transactions ? data.transactions.length : '0');

        // Create Bar Chart
        createBarChart(data);

        // Create Donut Chart
        createDonutChart(data);

        // Display patterns
        displayPatterns(data.patterns || []);

        // Display recommendations
        displayRecommendations(data.recommendations || [], data.ai_summary);

        // Setup interactive listeners once
        setupInteractiveFeatures();
    }

    function setupInteractiveFeatures() {
        // 1. Monthly/Weekly Toggle for Bar Chart
        const toggleBtns = document.querySelectorAll('.toggle-pill-container .toggle-btn');
        toggleBtns.forEach(btn => {
            btn.onclick = function () {
                toggleBtns.forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentView = this.textContent.toLowerCase();
                createBarChart(currentData);
            };
        });

        // 2. Month Navigation for Donut Chart
        const prevBtn = document.querySelector('.card-sage .btn-secondary:first-of-type');
        const nextBtn = document.querySelector('.card-sage .btn-secondary:last-of-type');

        if (prevBtn) prevBtn.onclick = () => navigateMonth(-1);
        if (nextBtn) nextBtn.onclick = () => navigateMonth(1);

        // Set initial month label for donut chart
        const monthLabel = document.querySelector('.card-sage div[style*="font-weight: 600"]');
        if (monthLabel) monthLabel.textContent = `${monthNames[donutMonth - 1]} ${donutYear}`;
    }

    async function navigateMonth(offset) {
        donutMonth += offset;
        if (donutMonth > 12) {
            donutMonth = 1;
            donutYear++;
        } else if (donutMonth < 1) {
            donutMonth = 12;
            donutYear--;
        }

        // Update UI Label
        const monthLabel = document.querySelector('.card-sage div[style*="font-weight: 600"]');
        if (monthLabel) monthLabel.textContent = `${monthNames[donutMonth - 1]} ${donutYear}`;

        // Show loading in donut only? For now, refresh full data for simplicity or fetch specific
        try {
            const response = await fetch(`/api/anomalies-data?month=${donutMonth}&year=${donutYear}`);
            const data = await response.json();
            if (data.success) {
                // Update specific items
                createDonutChart(data);
                // We keep currentData for bar chart toggle, only update distribution parts
                currentData.category_labels = data.category_labels;
                currentData.category_values = data.category_values;
            }
        } catch (e) { console.error("Month nav error", e); }
    }

    function createBarChart(data) {
        const ctx = document.getElementById('barChart');
        if (!ctx) return;

        if (barChartInstance) {
            barChartInstance.destroy();
        }

        const chartConfig = currentView === 'weekly' ? data.weekly_expenditure : data.monthly_expenditure;

        if (!chartConfig || !chartConfig.labels || chartConfig.labels.length === 0) {
            // Fallback to dummy style if data missing
            chartConfig.labels = ['-', '-', '-', '-', '-', '-'];
            chartConfig.debit_data = [0, 0, 0, 0, 0, 0];
            chartConfig.credit_data = [0, 0, 0, 0, 0, 0];
        }

        barChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: chartConfig.labels,
                datasets: [
                    {
                        label: 'Debit',
                        data: chartConfig.debit_data,
                        backgroundColor: '#000000',
                        borderRadius: 4,
                        barThickness: 20
                    },
                    {
                        label: 'Credit',
                        data: chartConfig.credit_data,
                        backgroundColor: 'rgba(0,0,0,0.4)',
                        borderRadius: 4,
                        barThickness: 20
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: '#1a365d',
                        titleColor: '#fff',
                        bodyColor: '#fff',
                        padding: 12,
                        cornerRadius: 8
                    }
                },
                scales: {
                    x: {
                        grid: { display: false },
                        ticks: { color: 'rgba(0,0,0,0.6)', font: { size: 11 } } // Dark ticks
                    },
                    y: {
                        grid: { color: 'rgba(0,0,0,0.1)' },
                        ticks: { color: 'rgba(0,0,0,0.6)', font: { size: 11 } },
                        beginAtZero: true
                    }
                }
            }
        });
    }

    function createDonutChart(data) {
        const ctx = document.getElementById('donutChart');
        if (!ctx) return;

        if (donutChartInstance) {
            donutChartInstance.destroy();
        }

        const labels = data.category_labels && data.category_labels.length > 0 ? data.category_labels : ['No Data'];
        const values = data.category_values && data.category_values.length > 0 ? data.category_values : [100];

        // Define a nice palette of neutral darks/pastels
        const colors = ['#1a202c', '#4a5568', '#718096', '#a0aec0', '#cbd5e0', '#2d3748', '#4a5568'];

        donutChartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: values,
                    backgroundColor: colors,
                    borderWidth: 0,
                    cutout: '70%',
                    hoverOffset: 15
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: '#1a365d',
                        titleColor: '#fff',
                        callbacks: {
                            label: function (context) {
                                return `${context.label}: ${context.raw}%`;
                            }
                        }
                    }
                }
            }
        });

        // Update legend
        const legendContainer = document.getElementById('donutLegend');
        legendContainer.innerHTML = labels.map((label, i) => `
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; font-size: 13px; color: rgba(0,0,0,0.7); padding: 4px 8px; border-radius: 8px; transition: background 0.2s;">
                <div style="display: flex; align-items: center; gap: 10px;">
                     <span style="width: 10px; height: 10px; border-radius: 3px; background: ${colors[i % colors.length]}"></span>
                     <span style="font-weight: 500;">${label}</span>
                </div>
                <strong style="color: #1a202c;">${values[i]}%</strong>
            </div>
        `).join('');
    }

    function displayPatterns(patterns) {
        const list = document.getElementById('patternsList');
        list.innerHTML = '';

        if (patterns.length > 0) {
            patterns.forEach(pattern => {
                const li = document.createElement('li');
                li.style.cssText = 'padding: 8px 0; border-bottom: 1px solid rgba(0,0,0,0.1); margin-bottom: 4px;';
                li.textContent = '‚Ä¢ ' + pattern;
                list.appendChild(li);
            });
        } else {
            list.innerHTML = '<li>No patterns detected yet</li>';
        }
    }

    function displayRecommendations(recommendations, summary) {
        const list = document.getElementById('recommendationsList');
        list.innerHTML = '';

        // Add summary paragraph first if exists
        if (summary) {
            const p = document.createElement('p');
            p.textContent = summary;
            p.style.marginBottom = '12px';
            list.appendChild(p);
        }

        if (recommendations.length > 0) {
            recommendations.forEach(rec => {
                const li = document.createElement('li');
                li.style.cssText = 'padding: 8px 0; font-size: 14px; display: flex; gap: 8px;';
                li.innerHTML = '<span style="color: var(--card-mustard);">‚Ä¢</span> ' + rec;
                list.appendChild(li);
            });
        }
    }

    function refreshAnalytics() {
        loadAnalytics();
    }

    function showToast(message, isError = false) {
        const toast = document.createElement('div');
        toast.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            background: ${isError ? '#ef4444' : '#10b981'};
            color: white;
            border-radius: 8px;
            font-weight: 600;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            z-index: 9999;
            animation: slideIn 0.3s ease;
        `;
        toast.textContent = message;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 4000);
    }

    // Simple Upload
    async function uploadReceiptFile() {
        const input = document.getElementById('receiptUpload');
        const file = input.files[0];
        if (!file) { showToast('Select file', true); return; }

        const formData = new FormData();
        formData.append('file', file);
        showToast('Uploading...');

        try {
            const r = await fetch('/upload-receipt', { method: 'POST', body: formData });
            const d = await r.json();
            if (d.success) showToast('Done!');
            else showToast('Failed', true);
        } catch (e) { showToast('Error', true); }
    }

    // Load on init
    document.addEventListener('DOMContentLoaded', loadAnalytics);
</script>

<style>
    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }

        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
</style>
{% endblock %}